<div class="approvals">
  <div class="page-header">
    <h1 class="page-title">Approvals</h1>
    <p class="page-subtitle">Review and approve purchase requisitions</p>
  </div>

 
  <div class="approval-tabs" *ngIf="canAccessITApprovals() || canAccessFinanceApprovals() || isDepartmentManager()">
    <!-- Department Approvals Tab -->
    <button class="tab-button" 
            *ngIf="isDepartmentManager()"
            [class.active]="activeTab() === 'department'" 
            (click)="setActiveTab('department')">
      Department Approvals
    </button>
    
    <!-- IT Approvals Tab -->
    <button class="tab-button" 
            *ngIf="canAccessITApprovals()"
            [class.active]="activeTab() === 'it'" 
            (click)="setActiveTab('it')">
      IT Manager Approvals
    </button>
    
    <!-- Finance Approvals Tab -->
    <button class="tab-button" 
            *ngIf="canAccessFinanceApprovals()"
            [class.active]="activeTab() === 'finance'" 
            (click)="setActiveTab('finance')">
      Finance Approvals
    </button>
  </div>

  <!-- Department Approvals -->
  <div *ngIf="activeTab() === 'department' && isDepartmentManager()" class="approval-content">
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Item</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Requester</th>
            <th>Department</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of departmentPendings()">
            <td>{{ item.id }}</td>
            <td>
              <div *ngIf="item.items && item.items.length > 0; else legacyItem">
                <div *ngFor="let reqItem of item.items; let isLast = last" class="item-row">
                  {{ reqItem.itemName }}
                  <span *ngIf="!isLast" class="item-separator">, </span>
                </div>
              </div>
              <ng-template #legacyItem>
                {{ item.itemName || 'N/A' }}
              </ng-template>
            </td>
            <td>
              <div *ngIf="item.items && item.items.length > 0; else legacyQuantity">
                {{ getTotalQuantity(item) }}
              </div>
              <ng-template #legacyQuantity>
                {{ item.quantity || 0 }}
              </ng-template>
            </td>
            <td>
              <div *ngIf="item.items && item.items.length > 0; else legacyPrice">
                {{ formatCurrency(getRequisitionTotalAmount(item)) }}
              </div>
              <ng-template #legacyPrice>
                {{ formatCurrency(item.price || 0) }}
              </ng-template>
            </td>
            <td>{{ item.createdBy }}</td>
            <td>{{ item.department }}</td>
            <td>
              <div class="action-buttons">
                <button class="btn-approve" (click)="departmentDecision(item.id, 'APPROVE')">Approve</button>
                <button class="btn-reject" (click)="departmentDecision(item.id, 'REJECT')">Reject</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- IT Approvals -->
  <div *ngIf="activeTab() === 'it' && canAccessITApprovals()" class="approval-content">
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Item</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Requester</th>
            <th>Department</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of itPendings()">
            <td>{{ item.id }}</td>
            <td>
              <div *ngIf="item.items && item.items.length > 0; else legacyItem">
                <div *ngFor="let reqItem of item.items; let isLast = last" class="item-row">
                  {{ reqItem.itemName }}
                  <span *ngIf="!isLast" class="item-separator">, </span>
                </div>
              </div>
              <ng-template #legacyItem>
                {{ item.itemName || 'N/A' }}
              </ng-template>
            </td>
            <td>
              <div *ngIf="item.items && item.items.length > 0; else legacyQuantity">
                {{ getTotalQuantity(item) }}
              </div>
              <ng-template #legacyQuantity>
                {{ item.quantity || 0 }}
              </ng-template>
            </td>
            <td>
              <div *ngIf="item.items && item.items.length > 0; else legacyPrice">
                {{ formatCurrency(getRequisitionTotalAmount(item)) }}
              </div>
              <ng-template #legacyPrice>
                {{ formatCurrency(item.price || 0) }}
              </ng-template>
            </td>
            <td>{{ item.createdBy }}</td>
            <td>{{ item.department }}</td>
            <td>
              <div class="action-buttons">
                <button class="btn-approve" (click)="itDecision(item.id, 'APPROVE')">Approve</button>
                <button class="btn-reject" (click)="itDecision(item.id, 'REJECT')">Reject</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Finance Approvals -->
  <div *ngIf="activeTab() === 'finance' && canAccessFinanceApprovals()" class="approval-content">
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Item</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Requester</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of finPendings()">
            <td>{{ item.id }}</td>
            <td>
              <div *ngIf="item.items && item.items.length > 0; else legacyItem">
                <div *ngFor="let reqItem of item.items; let isLast = last" class="item-row">
                  {{ reqItem.itemName }}
                  <span *ngIf="!isLast" class="item-separator">, </span>
                </div>
              </div>
              <ng-template #legacyItem>
                {{ item.itemName || 'N/A' }}
              </ng-template>
            </td>
            <td>
              <div *ngIf="item.items && item.items.length > 0; else legacyQuantity">
                {{ getTotalQuantity(item) }}
              </div>
              <ng-template #legacyQuantity>
                {{ item.quantity || 0 }}
              </ng-template>
            </td>
            <td>
              <div *ngIf="item.items && item.items.length > 0; else legacyPrice">
                {{ formatCurrency(getRequisitionTotalAmount(item)) }}
              </div>
              <ng-template #legacyPrice>
                {{ formatCurrency(item.price || 0) }}
              </ng-template>
            </td>
            <td>{{ item.createdBy }}</td>
            <td>
              <div class="action-buttons">
                <button class="btn-approve" (click)="financeDecision(item.id, 'APPROVE')">Approve</button>
                <button class="btn-reject" (click)="financeDecision(item.id, 'REJECT')">Reject</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Budget Summary Section - Below Requisitions -->
    <div class="budget-summary-section" *ngIf="!budgetLoading() && budgets().length > 0">
      <h3 class="section-title">ðŸ’° Budget Overview</h3>
      <div class="budget-cards">
        <div class="budget-card" *ngFor="let budget of budgets()" [class]="getBudgetStatusClass(budget)">
          <div class="budget-header">
            <h4>{{ budget.department }}</h4>
            <span class="budget-status" [class]="getBudgetStatusClass(budget)">
              {{ getBudgetProgressPercentage(budget) | number:'1.0-1' }}% Used
            </span>
          </div>
          <div class="budget-progress">
            <div class="progress-bar">
              <div class="progress-fill" 
                   [style.width.%]="getBudgetProgressPercentage(budget)"
                   [class]="getBudgetStatusClass(budget)">
              </div>
            </div>
          </div>
          <div class="budget-details">
            <div class="budget-item">
              <span class="label">Total Budget:</span>
              <span class="value">{{ formatCurrency(budget.totalBudget) }}</span>
            </div>
            <div class="budget-item">
              <span class="label">Used:</span>
              <span class="value used">{{ formatCurrency(budget.usedBudget) }}</span>
            </div>
            <div class="budget-item">
              <span class="label">Remaining:</span>
              <span class="value remaining">{{ formatCurrency(budget.remainingBudget) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading state for budget -->
    <div *ngIf="budgetLoading()" class="budget-loading">
      <div class="loading-spinner"></div>
      <p>Loading budget data...</p>
    </div>
  </div>

</div>
